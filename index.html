<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" href="./favicon.png">
<title>ãŠãã™ã‚Šç®¡ç†</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f5f5f5;
}

header {
  padding: 24px;
  background: #ffffff;
  text-align: center;
  font-size: 40px;
  font-weight: bold;
  border-bottom: 1px solid #ddd;
}

#date, #streak {
  font-size: 22px;
  margin-top: 8px;
}

nav {
  display: flex;
  background: #ffffff;
  border-bottom: 1px solid #ddd;
}

nav button {
  flex: 1;
  padding: 18px;
  font-size: 28px;
  border: none;
  background: none;
  font-weight: bold;
  color: #2196F3;
}

nav button.active {
  background: #e0e0e0;
}

main {
  padding: 20px;
}

.medicine {
  display: flex;
  align-items: center;
  padding: 24px;
  margin-bottom: 16px;
  background: #ffffff;
  border-radius: 8px;
  font-size: 28px;
  cursor: pointer;
}

.medicine.taken {
  opacity: 0.5;
}

.check {
  width: 28px;
  height: 28px;
  margin-right: 16px;
  border-radius: 50%;
  border: 2px solid #666;
}

.medicine.taken .check {
  background: #4caf50;
  border-color: #4caf50;
}

#add {
  margin-top: 20px;
  text-align: center;
}

#add input, #add select, #add button {
  font-size: 18px;
  padding: 8px;
  margin: 4px;
}
</style>
</head>

<body>

<header>
  ğŸ’Š ãŠãã™ã‚Šç®¡ç†
  <div id="date"></div>
  <div id="streak"></div>
</header>

<nav>
  <button id="btn-morning" onclick="showPage('morning')">æœ</button>
  <button id="btn-night" onclick="showPage('night')">å¤œ</button>
</nav>

<main id="list"></main>

<div id="add">
  <input id="newName" placeholder="è–¬ã®åå‰">
  <select id="newTiming">
    <option value="morning">æœ</option>
    <option value="night">å¤œ</option>
  </select>
  <button onclick="addMedicine()">è¿½åŠ </button>
</div>

<script>
/* ===== åŸºæœ¬ ===== */
function today() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}

document.getElementById("date").textContent = today();

/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
let medicines = JSON.parse(localStorage.getItem("medicines")) ?? [
  { name: "è¡€åœ§ã®è–¬", timing: "morning", order: 1, taken: false },
  { name: "ãƒ“ã‚¿ãƒŸãƒ³", timing: "morning", order: 2, taken: false },
  { name: "æŠ—ç”Ÿç‰©è³ª", timing: "night", order: 1, taken: false }
];

let history = JSON.parse(localStorage.getItem("history")) ?? [];

/* ===== ä¿å­˜ ===== */
function save() {
  localStorage.setItem("medicines", JSON.stringify(medicines));
  localStorage.setItem("history", JSON.stringify(history));
}

/* ===== æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆ ===== */
function dailyReset() {
  const lastDate = localStorage.getItem("lastDate");
  if (lastDate !== today()) {
    const allTaken = medicines.every(m => m.taken);
    history.push(allTaken);
    medicines.forEach(m => m.taken = false);
    localStorage.setItem("lastDate", today());
    save();
  }
}

/* ===== é€£ç¶šè¨˜éŒ² ===== */
function calcStreak() {
  let count = 0;
  for (let i = history.length - 1; i >= 0; i--) {
    if (history[i]) count++;
    else break;
  }
  document.getElementById("streak").textContent =
    count > 0 ? `ğŸ”¥ ${count}æ—¥é€£ç¶šæœè–¬ä¸­` : "â¸ é€£ç¶šè¨˜éŒ²ãªã—";
}

/* ===== è¡¨ç¤º ===== */
let current = "morning";

function showPage(timing) {
  current = timing;
  document.getElementById("btn-morning").classList.toggle("active", timing === "morning");
  document.getElementById("btn-night").classList.toggle("active", timing === "night");

  const list = document.getElementById("list");
  list.innerHTML = "";

  medicines
    .filter(m => m.timing === timing)
    .forEach(m => {
      const div = document.createElement("div");
      div.className = "medicine" + (m.taken ? " taken" : "");
      div.innerHTML = `<div class="check"></div><div>${m.name}</div>`;
      div.onclick = () => {
        m.taken = !m.taken;
        save();
        showPage(current);
      };
      list.appendChild(div);
    });

  calcStreak();
}

/* ===== è–¬è¿½åŠ  ===== */
function addMedicine() {
  const name = document.getElementById("newName").value.trim();
  const timing = document.getElementById("newTiming").value;
  if (!name) return;

  medicines.push({ name, timing, order: Date.now(), taken: false });
  document.getElementById("newName").value = "";
  save();
  showPage(current);
}

/* ===== ç”»é¢å¾©å¸°æ™‚ãƒã‚§ãƒƒã‚¯ ===== */
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) {
    dailyReset();
    showPage(current);
  }
});

/* ===== 0æ™‚ãƒªã‚»ãƒƒãƒˆ ===== */
(function scheduleMidnight() {
  const now = new Date();
  const next = new Date();
  next.setHours(24, 0, 0, 0);
  setTimeout(() => {
    dailyReset();
    showPage(current);
    scheduleMidnight();
  }, next - now);
})();

/* ===== åˆæœŸè¡¨ç¤º ===== */
dailyReset();
showPage(new Date().getHours() < 15 ? "morning" : "night");

/* ===== é£²ã¿å¿˜ã‚Œè­¦å‘Š ===== */
if ("serviceWorker" in navigator && "Notification" in window) {
  navigator.serviceWorker.register("./sw.js");
  Notification.requestPermission();
}

function notify(body) {
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: "notify", body });
  }
}

setTimeout(() => {
  const nightUntaken = medicines.some(m => m.timing === "night" && !m.taken);
  if (nightUntaken) {
    notify("âš  å¤œã®ãŠè–¬ãŒã¾ã é£²ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
  }
}, 20 * 60 * 60 * 1000); // 20æ™‚
</script>

</body>
</html>